resources:
  repositories:
  - repository: onnxruntime-inference-examples # The name used to reference this repository in the checkout step
    type: github
    endpoint: ort-examples
    name: microsoft/onnxruntime-inference-examples
    ref: edgchen1/test_maui_sample

jobs:
- job: IosBuildSample
  displayName: "iOS build sample"

  pool:
    vmImage: "macOS-12"

  steps:
  - checkout: self                           # due to checkout multiple repos, the root directory is $(Build.SourcesDirectory)/onnxruntime
    submodules: false

  - checkout: onnxruntime-inference-examples # due to checkout multiple repos, the root directory is $(Build.SourcesDirectory)/onnxruntime-inference-examples
    submodules: false

  - task: InstallAppleCertificate@2
    inputs:
      certSecureFile: '$(ios_signing_certificate_name)'
      certPwd: '$(ios_signing_certificate_password)'
      keychain: 'temp'
      deleteCert: true
    displayName: 'Install ORT Mobile Test Signing Certificate'

  - task: InstallAppleProvisioningProfile@1
    inputs:
      provProfileSecureFile: '$(ios_provision_profile_name)'
      removeProfile: true
    displayName: 'Install ORT Mobile Test Provisioning Profile'

  - task: DownloadPipelineArtifact@2
    inputs:
      buildType: 'specific'
      project: '530acbc4-21bc-487d-8cd8-348ff451d2ff'
      definition: '940'
      buildVersionToDownload: 'specific'
      pipelineId: '224411'
      artifactName: 'drop-signed-nuget-CPU'
      targetPath: '$(Pipeline.Workspace)'

  - bash: dotnet --info

  - bash: |
      set -x -e
      # add nuget source for downloaded artifacts
      dotnet nuget add source --name ort_dev "$(Pipeline.Workspace)/drop-signed-nuget-CPU"
      dotnet workload restore ./MauiVisionSample.sln
      # `-bl` produces the binlog
      # dotnet publish -bl -f:net6.0-ios -c:Release -r:ios-arm64 ./MauiVisionSample/MauiVisionSample.csproj
      # dotnet publish -f:net6.0-ios -c:Release -r:ios-arm64 --no-self-contained ./MauiVisionSample.sln
      dotnet publish -bl -f:net6.0-ios -c:Release /p:"ArchiveOnBuild=true;NullabilityInfoContextSupport=true" -r:ios-arm64 ./MauiVisionSample.sln
    workingDirectory: onnxruntime-inference-examples/mobile/examples/Maui/MauiVisionSample

  - task: PublishBuildArtifacts@1
    condition: succeededOrFailed()
    inputs:
      pathtoPublish: 'onnxruntime-inference-examples/mobile/examples/Maui/MauiVisionSample/msbuild.binlog'
      artifactName: 'msbuild.binlog'

  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: 'onnxruntime-inference-examples/mobile/examples/Maui/MauiVisionSample/MauiVisionSample/bin/Release/net6.0-ios/ios-arm64/publish//MauiVisionSample.ipa'
      ArtifactName: 'MauiVisionSample.ipa'